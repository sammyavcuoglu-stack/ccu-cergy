<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RER A ‚Äî Sartrouville</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --red: #E30614;
      --bg: #0a0a0a;
      --bg2: #141414;
      --bg3: #1e1e1e;
      --text: #f0ece4;
      --muted: #6b6660;
      --border: #2a2a2a;
      --green: #3ddc84;
      --yellow: #f5c518;
      --orange: #f08030;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text); font-family: 'DM Mono', monospace; min-height: 100vh; }

    header {
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      padding: 0 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 72px;
    }
    .logo { display: flex; align-items: center; gap: 1rem; }
    .rer-badge {
      width: 48px; height: 48px;
      background: var(--red);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Syne', sans-serif; font-weight: 800; font-size: 0.9rem;
      color: white; box-shadow: 0 0 24px rgba(227,6,20,0.4);
    }
    .logo-text { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.4rem; }
    .logo-text span { color: var(--red); }
    .live-indicator { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: var(--muted); text-transform: uppercase; }
    .live-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.8)} }

    main { max-width: 900px; margin: 0 auto; padding: 2rem; }

    .station-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    .station-name {
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    .station-sub { color: var(--muted); font-size: 0.8rem; letter-spacing: 0.1em; text-transform: uppercase; }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      gap: 1rem;
    }
    .status-info { font-size: 0.8rem; color: var(--muted); }
    .btn-refresh {
      background: var(--red); color: white; border: none;
      font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.9rem;
      padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn-refresh:hover { opacity: 0.85; }
    .btn-refresh.loading { opacity: 0.5; pointer-events: none; }

    .refresh-bar { height: 2px; background: var(--border); border-radius: 1px; margin-bottom: 1.5rem; overflow: hidden; }
    .refresh-progress { height: 100%; background: var(--red); border-radius: 1px; transition: width 1s linear; }

    .section-title {
      font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em;
      color: var(--muted); margin-bottom: 1rem;
    }

    .departures { display: flex; flex-direction: column; gap: 0.5rem; }

    .dep-row {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem 1.5rem;
      display: grid;
      grid-template-columns: 90px 1fr 80px 110px;
      align-items: center;
      gap: 1rem;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
    .dep-row.cancelled { opacity: 0.5; border-color: var(--red); }

    .dep-time { font-size: 1.5rem; font-weight: 500; }
    .dep-time.soon { color: var(--green); }
    .dep-time.very-soon { color: var(--yellow); animation: blink 1s infinite; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }

    .dep-dest { font-size: 0.95rem; font-weight: 500; }
    .dep-mission { font-size: 0.7rem; color: var(--muted); margin-top: 0.2rem; }

    .dep-wait { text-align: right; font-size: 0.8rem; color: var(--muted); }
    .dep-wait .mins { font-size: 1.1rem; font-weight: 500; color: var(--text); }

    .dep-status { text-align: right; }
    .badge {
      display: inline-block; font-size: 0.65rem; letter-spacing: 0.08em;
      text-transform: uppercase; padding: 0.25rem 0.6rem; border-radius: 4px;
    }
    .badge.ok { background: rgba(61,220,132,0.15); color: var(--green); border: 1px solid rgba(61,220,132,0.3); }
    .badge.late { background: rgba(240,128,48,0.15); color: var(--orange); border: 1px solid rgba(240,128,48,0.3); }
    .badge.cancel { background: rgba(227,6,20,0.15); color: var(--red); border: 1px solid rgba(227,6,20,0.3); }

    .empty { text-align: center; padding: 3rem; color: var(--muted); }
    .empty .icon { font-size: 3rem; display: block; margin-bottom: 1rem; }
    .empty .title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.1rem; color: var(--text); margin-bottom: 0.5rem; }

    .error-box {
      background: rgba(227,6,20,0.08); border: 1px solid rgba(227,6,20,0.3);
      border-radius: 8px; padding: 1.5rem; color: #ff6b6b; font-size: 0.85rem; line-height: 1.6;
    }

    .messages { margin-top: 2rem; }
    .msg-card {
      background: var(--bg2); border: 1px solid var(--border);
      border-left: 3px solid var(--yellow); border-radius: 8px;
      padding: 1rem 1.5rem; margin-bottom: 0.75rem;
    }
    .msg-body { font-size: 0.8rem; color: var(--muted); line-height: 1.6; }

    @media (max-width: 600px) {
      .dep-row { grid-template-columns: 70px 1fr 90px; }
      .dep-wait { display: none; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <div class="rer-badge">RER<br>A</div>
    <div class="logo-text">Trafic <span>Temps R√©el</span></div>
  </div>
  <div class="live-indicator">
    <div class="live-dot"></div>
    LIVE
  </div>
</header>

<main>
  <div class="station-header">
    <div class="station-name">üöâ Sartrouville</div>
    <div class="station-sub">RER A ‚Äî Prochains passages</div>
  </div>

  <div class="toolbar">
    <div class="status-info" id="lastUpdate">En attente‚Ä¶</div>
    <button class="btn-refresh" id="btnRefresh" onclick="fetchData()">‚Üª Actualiser</button>
  </div>

  <div class="refresh-bar">
    <div class="refresh-progress" id="bar" style="width:100%"></div>
  </div>

  <div class="section-title">Prochains passages</div>
  <div class="departures" id="list">
    <div class="empty">
      <span class="icon">üöÜ</span>
      <div class="title">Cliquez sur Actualiser</div>
      <div>pour charger les prochains passages</div>
    </div>
  </div>

  <div class="messages">
    <div class="section-title">Infos trafic</div>
    <div id="msgs"></div>
  </div>
</main>

<script>
  var PROXY = 'https://rera-proxy.sammy-avcuoglu.workers.dev/proxy';
  var STOP  = 'STIF:StopArea:SP:43191:';
  var LINE  = 'STIF:Line::C01742:';

  var countdown = 60;
  var timer = null;

  function esc(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function formatTime(iso) {
    if (!iso) return '--:--';
    var d = new Date(iso);
    var h = String(d.getHours()).padStart(2,'0');
    var m = String(d.getMinutes()).padStart(2,'0');
    return h + ':' + m;
  }

  function minsUntil(iso) {
    if (!iso) return null;
    return Math.round((new Date(iso) - new Date()) / 60000);
  }

  function setLoading(on) {
    var btn = document.getElementById('btnRefresh');
    btn.className = on ? 'btn-refresh loading' : 'btn-refresh';
    btn.textContent = on ? 'Chargement‚Ä¶' : '‚Üª Actualiser';
  }

  function fetchData() {
    setLoading(true);

    var url = PROXY + '/stop-monitoring?MonitoringRef=' + encodeURIComponent(STOP);

    fetch(url, { headers: { 'Accept': 'application/json' } })
      .then(function(resp) {
        return resp.text().then(function(text) {
          if (!resp.ok) throw new Error('HTTP ' + resp.status + ' ‚Äî ' + text.slice(0, 300));
          return JSON.parse(text);
        });
      })
      .then(function(data) {
        renderDepartures(data);
        var now = new Date();
        document.getElementById('lastUpdate').textContent =
          'Actualis√© √† ' + String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
        setLoading(false);
        startCountdown();
      })
      .catch(function(err) {
        document.getElementById('list').innerHTML =
          '<div class="error-box"><strong>Erreur :</strong> ' + esc(err.message) + '</div>';
        setLoading(false);
      });

    fetch(PROXY + '/general-message?LineRef=' + encodeURIComponent(LINE), { headers: { 'Accept': 'application/json' } })
      .then(function(r) { return r.json(); })
      .then(function(d) { renderMessages(d); })
      .catch(function() {});
  }

  function renderDepartures(data) {
    var list = document.getElementById('list');
    var visits = [];
    try {
      visits = data.Siri.ServiceDelivery.StopMonitoringDelivery[0].MonitoredStopVisit || [];
    } catch(e) {}

    if (!visits.length) {
      list.innerHTML = '<div class="empty"><span class="icon">üïê</span><div class="title">Aucun passage trouv√©</div></div>';
      return;
    }

    var html = '';
    for (var i = 0; i < visits.length; i++) {
      var v = visits[i];
      var call = (v.MonitoredVehicleJourney && v.MonitoredVehicleJourney.MonitoredCall) || {};
      var journey = v.MonitoredVehicleJourney || {};

      var dept = call.ExpectedDepartureTime || call.AimedDepartureTime || call.ExpectedArrivalTime || call.AimedArrivalTime;
      var aimed = call.AimedDepartureTime || call.AimedArrivalTime;
      var dest = '';
      if (journey.DestinationName && journey.DestinationName[0]) dest = journey.DestinationName[0].value || '';
      if (!dest && journey.DirectionName && journey.DirectionName[0]) dest = journey.DirectionName[0].value || '';
      if (!dest) dest = '‚Äî';

      var cancelled = call.DepartureStatus === 'cancelled';
      var delayed = dept && aimed && (new Date(dept) - new Date(aimed)) > 60000;
      var mins = minsUntil(dept);

      var timeClass = '';
      if (mins !== null && mins <= 2) timeClass = 'very-soon';
      else if (mins !== null && mins <= 5) timeClass = 'soon';

      var waitHtml = '‚Äî';
      if (mins !== null) {
        waitHtml = mins <= 0 ? '<span class="mins">√Ä quai</span>' : '<span class="mins">' + mins + '</span> min';
      }

      var badgeHtml = '';
      if (cancelled) badgeHtml = '<span class="badge cancel">Supprim√©</span>';
      else if (delayed) badgeHtml = '<span class="badge late">Retard</span>';
      else badgeHtml = '<span class="badge ok">√Ä l\'heure</span>';

      html += '<div class="dep-row' + (cancelled ? ' cancelled' : '') + '">';
      html += '<div class="dep-time ' + timeClass + '">' + formatTime(dept) + '</div>';
      html += '<div><div class="dep-dest">' + esc(dest) + '</div></div>';
      html += '<div class="dep-wait">' + waitHtml + '</div>';
      html += '<div class="dep-status">' + badgeHtml + '</div>';
      html += '</div>';
    }
    list.innerHTML = html;
  }

  function renderMessages(data) {
    var el = document.getElementById('msgs');
    var msgs = [];
    try {
      msgs = data.Siri.ServiceDelivery.GeneralMessageDelivery[0].InfoMessage || [];
    } catch(e) {}

    if (!msgs.length) {
      el.innerHTML = '<div style="color:var(--muted);font-size:0.8rem;">Aucun message en cours.</div>';
      return;
    }
    var html = '';
    for (var i = 0; i < msgs.length; i++) {
      var body = '';
      try { body = msgs[i].Content.Message[0].MessageText.value; } catch(e) {}
      html += '<div class="msg-card"><div class="msg-body">' + esc(body) + '</div></div>';
    }
    el.innerHTML = html;
  }

  function startCountdown() {
    clearInterval(timer);
    countdown = 60;
    var bar = document.getElementById('bar');
    timer = setInterval(function() {
      countdown--;
      bar.style.width = (countdown / 60 * 100) + '%';
      if (countdown <= 0) {
        clearInterval(timer);
        fetchData();
      }
    }, 1000);
  }

  // D√©marrage
  fetchData();
</script>

</body>
</html>
