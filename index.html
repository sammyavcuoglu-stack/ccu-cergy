<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Supervision RER A â€” Ouest</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg:     #1e2330;
      --bg2:    #252b3b;
      --bg3:    #2d3447;
      --border: #353d52;
      --text:   #e8eaf0;
      --muted:  #6b7494;
      --green:  #2ecc71;
      --orange: #e67e22;
      --red:    #e74c3c;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%; height: 100%;
      overflow: hidden;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Barlow', sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 1.2rem 1.5rem;
      gap: 1rem;
    }

    /* HEADER */
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.2rem;
      flex-shrink: 0;
      position: relative;
    }
    .logo-badges { display: flex; align-items: center; gap: 0.5rem; }
    .badge-rer {
      background: #1a3a8f; color: white;
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 900; font-size: 1rem;
      padding: 0.2rem 0.5rem; border-radius: 4px;
    }
    .badge-a {
      background: #e2001a; color: white;
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 900; font-size: 1.2rem;
      width: 32px; height: 32px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }
    .badge-sncf {
      background: #c0392b; color: white;
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700; font-size: 0.7rem;
      padding: 0.15rem 0.4rem; border-radius: 3px;
    }
    h1 {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 800; font-size: 2.2vw;
      letter-spacing: 0.04em; text-transform: uppercase; color: white;
    }
    .live-dot {
      position: absolute; top: 4px; right: 0;
      width: 12px; height: 12px;
      background: var(--green); border-radius: 50%;
      animation: livepulse 2.5s ease-in-out infinite;
    }
    @keyframes livepulse {
      0%,100% { opacity:1; transform:scale(1); }
      50%      { opacity:.3; transform:scale(.7); }
    }

    /* GRILLE */
    .grid-top {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      flex: 1;
      min-height: 0;
    }
    .grid-bottom {
      flex-shrink: 0;
    }

    /* PANNEAU */
    .panel {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .panel-title {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700; font-size: 1.2rem;
      letter-spacing: 0.1em; text-transform: uppercase;
      color: white; text-align: center;
      padding: 0.75rem 1rem;
      background: var(--bg3);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .panel-body { padding: 1.2rem; flex: 1; overflow: hidden; }

    /* RETARDS */
    .delay-row {
      display: flex; align-items: baseline; gap: 1rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
    }
    .delay-row:last-child { border-bottom: none; }
    .delay-mission {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 800; font-size: 3.5vw;
      color: white; letter-spacing: 0.03em; min-width: 10vw;
    }
    .delay-mins {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700; font-size: 3.2vw;
    }
    .delay-mins.orange { color: var(--orange); }
    .delay-mins.red    { color: var(--red); }
    .no-delay {
      display: flex; align-items: center; justify-content: center;
      height: 100%; flex-direction: column; gap: 0.75rem;
      color: var(--muted); font-size: 1vw;
    }
    .no-delay-dot {
      width: 10px; height: 10px;
      background: var(--green); border-radius: 50%;
      animation: livepulse 2s infinite;
    }

    /* Ã‰TAT TRAFIC */
    .trafic-state-box {
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      height: 100%;
      background: transparent;
    }
    .trafic-state-capsule {
      display: flex; align-items: center; justify-content: center;
      width: 70%; padding: 2.5vw 0;
      border-radius: 2vw;
    }
    .trafic-state-box.fluide    .trafic-state-capsule { background: var(--green); }
    .trafic-state-box.perturbe  .trafic-state-capsule { background: var(--orange); }
    .trafic-state-box.interrompu .trafic-state-capsule { background: var(--red); }
    .trafic-state-label {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 900; font-size: 5vw;
      color: white; letter-spacing: 0.05em; text-transform: uppercase;
    }

    /* COMMUNICATION */
    .comm-inner {
      display: flex; gap: 1rem;
    }
    .comm-msg {
      flex: 1;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.9rem 1.2rem;
      font-size: 1vw; line-height: 1.6;
      color: var(--text);
    }
    .comm-msg.perturbe  { border-left: 4px solid var(--orange); color: #f0a870; }
    .comm-msg.interrompu { border-left: 4px solid var(--red);    color: #f08080; }
    .no-comm {
      display: flex; align-items: center; justify-content: center;
      padding: 1rem; color: var(--muted); font-size: 0.9rem;
    }
    /* 2 PANNEAUX COMMUNICATION */
    .comm-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .comm-source-label {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700; font-size: 0.85vw;
      letter-spacing: 0.12em; text-transform: uppercase;
      color: var(--muted); margin-bottom: 0.5rem;
    }
    .comm-source-label.sncf { color: #e8a020; }
    .comm-source-label.ratp { color: #6b9fe4; }

    /* CARROUSEL */
    .carousel-wrap {
      overflow: hidden;
      position: relative;
    }
    .carousel-slide {
      display: none;
      animation: slideDown 0.6s ease;
    }
    .carousel-slide.active {
      display: block;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .timestamp {
      text-align: center; font-size: 0.7rem;
      color: var(--muted); flex-shrink: 0; letter-spacing: 0.05em;
    }
    .error-box {
      background: rgba(231,76,60,.1); border: 1px solid rgba(231,76,60,.3);
      border-radius: 8px; padding: 1rem; font-size: .8rem; color: #e74c3c;
    }
  </style>
</head>
<body>

<header>
  <div class="logo-badges">
    <img src="data:image/png;base64,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" alt="RER A SNCF" style="height:2.5vw; width:auto;">
  </div>
  <h1>Supervision des RER A Ouest</h1>
  <div class="live-dot"></div>
</header>

<div class="grid-top">

  <!-- PANNEAU 1 : RETARDS -->
  <div class="panel">
    <div class="panel-title">Retards en cours</div>
    <div class="panel-body" id="panel-retards">
      <div class="no-delay"><div class="no-delay-dot"></div>Chargementâ€¦</div>
    </div>
  </div>

  <!-- PANNEAU 2 : Ã‰TAT DU TRAFIC -->
  <div class="panel">
    <div class="panel-title">Ã‰tat du trafic</div>
    <div class="panel-body" style="padding:0.5rem;">
      <div class="trafic-state-box fluide" id="trafic-box">
        <div class="trafic-state-capsule">
          <div class="trafic-state-label" id="trafic-label">Fluide</div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- BARRE BAS : COMMUNICATION -->
<div class="grid-bottom">
  <div class="panel">
    <div class="panel-title">Communication</div>
    <div class="panel-body">
      <div class="comm-grid">
        <div>
          <div class="comm-source-label sncf">ðŸš† SNCF</div>
          <div id="panel-comm-sncf"><div class="no-comm">Chargementâ€¦</div></div>
        </div>
        <div>
          <div class="comm-source-label ratp">ðŸš‡ RATP</div>
          <div id="panel-comm-ratp"><div class="no-comm">Chargementâ€¦</div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="timestamp" id="ts">â€”</div>

<script>
  var PROXY      = 'https://rera-proxy.sammy-avcuoglu.workers.dev/proxy';
  var STOP       = 'STIF:StopArea:SP:43191:';
  var LINE       = 'STIF:Line::C01742:';
  var LINE_NAVITIA = 'line:IDFM:C01742';
  var timer      = null;

  function esc(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function fetchData() {
    fetch(PROXY + '/stop-monitoring?MonitoringRef=' + encodeURIComponent(STOP), {
      headers: { 'Accept': 'application/json' }
    })
    .then(function(r) { return r.json(); })
    .then(function(d) { renderRetards(d); })
    .catch(function(e) {
      document.getElementById('panel-retards').innerHTML =
        '<div class="error-box">Erreur : ' + esc(e.message) + '</div>';
    });

    fetch(PROXY + '/general-message?LineRef=' + encodeURIComponent(LINE), {
      headers: { 'Accept': 'application/json' }
    })
    .then(function(r) { return r.json(); })
    .then(function(d) { renderTraficRATP(d); })
    .catch(function() {});

    fetch(PROXY + '/v2/navitia/line_reports/lines/' + encodeURIComponent(LINE_NAVITIA) + '/line_reports', {
      headers: { 'Accept': 'application/json' }
    })
    .then(function(r) { return r.json(); })
    .then(function(d) { renderTraficSNCF(d); })
    .catch(function() {});

    document.getElementById('ts').textContent =
      'ActualisÃ© Ã  ' + new Date().toLocaleTimeString('fr-FR',
        { hour:'2-digit', minute:'2-digit', second:'2-digit' });

    startCountdown();
  }

  function renderRetards(data) {
    var visits = [];
    try {
      visits = data.Siri.ServiceDelivery.StopMonitoringDelivery[0].MonitoredStopVisit || [];
    } catch(e) {}

    var retards = [];
    for (var i = 0; i < visits.length; i++) {
      var v     = visits[i];
      var call  = (v.MonitoredVehicleJourney && v.MonitoredVehicleJourney.MonitoredCall) || {};
      var j2    = v.MonitoredVehicleJourney || {};
      var dept  = call.ExpectedDepartureTime || call.AimedDepartureTime;
      var aimed = call.AimedDepartureTime;
      if (!dept || !aimed) continue;
      var delayMins = Math.round((new Date(dept) - new Date(aimed)) / 60000);
      if (delayMins <= 3) continue;
      var mission = '';
      try { mission = j2.VehicleJourneyName[0].value; } catch(e) {}
      if (!mission) try { mission = j2.JourneyNote[0].value; } catch(e) {}
      retards.push({ mission: mission, delay: delayMins });
    }

    var el = document.getElementById('panel-retards');
    if (!retards.length) {
      el.innerHTML = '<div class="no-delay"><div class="no-delay-dot"></div>Aucun retard dÃ©tectÃ©</div>';
      return;
    }
    var html = '';
    for (var k = 0; k < retards.length; k++) {
      var cls = retards[k].delay >= 10 ? 'red' : 'orange';
      html += '<div class="delay-row">';
      html += '<div class="delay-mission">' + esc(retards[k].mission) + '</div>';
      html += '<div class="delay-mins ' + cls + '">+' + retards[k].delay + ' min</div>';
      html += '</div>';
    }
    el.innerHTML = html;
  }

  // Carrousels actifs
  var carousels = {};

  function startCarousel(panelId, items) {
    // ArrÃªter l'ancien carrousel si existant
    if (carousels[panelId]) {
      clearInterval(carousels[panelId].timer);
      delete carousels[panelId];
    }
    if (items.length <= 1) return; // pas de carrousel si 1 seul message
    var idx = 0;
    function showSlide(i) {
      var slides = document.querySelectorAll('#' + panelId + ' .carousel-slide');
      for (var s = 0; s < slides.length; s++) slides[s].classList.remove('active');
      if (slides[i]) slides[i].classList.add('active');
    }
    showSlide(0);
    carousels[panelId] = {
      timer: setInterval(function() {
        idx = (idx + 1) % items.length;
        showSlide(idx);
      }, 15000)
    };
  }

  function getMsgClass(txt) {
    var low = txt.toLowerCase();
    var isInt = low.indexOf('interrompu') !== -1;
    var isTrv = low.indexOf('travaux') !== -1;
    if (isInt && !isTrv) return 'interrompu';
    if (isInt && isTrv)  return 'perturbe';
    if (low.indexOf('perturbÃ©') !== -1 || low.indexOf('perturbe') !== -1) return 'perturbe';
    return '';
  }

  function renderCarousel(panelId, items) {
    var comm = document.getElementById(panelId);
    if (!items.length) {
      comm.innerHTML = '<div class="no-comm">Aucun message en cours.</div>';
      return;
    }
    if (items.length === 1) {
      // Affichage fixe
      comm.innerHTML = '<div class="comm-msg ' + items[0].cls + '">' + items[0].html + '</div>';
      return;
    }
    // Carrousel
    var html = '<div class="carousel-wrap">';
    for (var i = 0; i < items.length; i++) {
      html += '<div class="carousel-slide' + (i === 0 ? ' active' : '') + '">';
      html += '<div class="comm-msg ' + items[i].cls + '">' + items[i].html + '</div>';
      html += '</div>';
    }
    html += '</div>';
    comm.innerHTML = html;
    startCarousel(panelId, items);
  }

  function renderTraficRATP(data) {
    var msgs = [];
    try {
      msgs = data.Siri.ServiceDelivery.GeneralMessageDelivery[0].InfoMessage || [];
    } catch(e) {}

    var items = [];
    for (var i = 0; i < msgs.length; i++) {
      var body = '';
      try { body = msgs[i].Content.Message[0].MessageText.value; } catch(e) {}
      if (!body) continue;
      items.push({ cls: getMsgClass(body), html: esc(body) });
    }
    renderCarousel('panel-comm-ratp', items);
  }

  function renderTraficSNCF(data) {
    var disruptions = [];
    try { disruptions = data.disruptions || []; } catch(e) {}

    var box   = document.getElementById('trafic-box');
    var label = document.getElementById('trafic-label');
    var comm  = document.getElementById('panel-comm-sncf');

    var hasInterrompu = false;
    var hasPerturbe   = false;
    var messages      = [];

    for (var i = 0; i < disruptions.length; i++) {
      var d = disruptions[i];

      // Ignorer les pannes d'ascenseurs
      var tags = d.tags || [];
      var isAscenseur = false;
      for (var t = 0; t < tags.length; t++) {
        if (tags[t] === 'Ascenseur') { isAscenseur = true; break; }
      }
      if (isAscenseur) continue;

      // RÃ©cupÃ©rer le texte du message (canal "titre" ou "moteur")
      var titre = '';
      var texte = '';
      var msgs = d.messages || [];
      for (var m = 0; m < msgs.length; m++) {
        var ch = (msgs[m].channel && msgs[m].channel.name) || '';
        if (ch === 'titre') titre = msgs[m].text || '';
        if (ch === 'moteur' && !texte) {
          // Nettoyer les balises HTML
          texte = (msgs[m].text || '').replace(/<[^>]+>/g, ' ').replace(/&amp;/g,'&').replace(/&eacute;/g,'Ã©').replace(/&#233;/g,'Ã©').replace(/&#224;/g,'Ã ').replace(/\s+/g,' ').trim();
        }
      }
      var affichage = texte || titre;
      if (!affichage) continue;

      messages.push({ titre: titre, texte: affichage, cause: d.cause || '' });

      // DÃ©terminer Ã©tat trafic basÃ© SNCF
      var cause = (d.cause || '').toLowerCase();
      var effect = ((d.severity && d.severity.effect) || '').toLowerCase();
      if (cause === 'travaux') continue; // travaux planifiÃ©s â†’ pas d'impact Ã©tat trafic
      if (effect === 'no_service' || affichage.toLowerCase().indexOf('interrompu') !== -1) hasInterrompu = true;
      else hasPerturbe = true;
    }

    // Mettre Ã  jour Ã©tat du trafic (basÃ© SNCF uniquement)
    box.className = 'trafic-state-box';
    if (hasInterrompu) {
      box.classList.add('interrompu');
      label.textContent = 'Interrompu';
    } else if (hasPerturbe) {
      box.classList.add('perturbe');
      label.textContent = 'PerturbÃ©';
    } else {
      box.classList.add('fluide');
      label.textContent = 'Fluide';
    }

    // Panneau communication SNCF
    var items = [];
    for (var k = 0; k < messages.length; k++) {
      var cause2 = messages[k].cause.toLowerCase();
      var txt2   = messages[k].texte.toLowerCase();
      var c = '';
      if (txt2.indexOf('interrompu') !== -1 && cause2 !== 'travaux') c = 'interrompu';
      else if (cause2 === 'travaux') c = 'perturbe';
      else c = 'perturbe';
      var h = '';
      if (messages[k].titre) h += '<strong>' + esc(messages[k].titre) + '</strong><br>';
      h += esc(messages[k].texte);
      items.push({ cls: c, html: h });
    }
    renderCarousel('panel-comm-sncf', items);
  }

  function startCountdown() {
    clearTimeout(timer);
    timer = setTimeout(fetchData, 45000);
  }

  fetchData();
</script>
</body>
</html>
