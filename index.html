<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Supervision RER A — Ouest</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg:     #1e2330;
      --bg2:    #252b3b;
      --bg3:    #2d3447;
      --border: #353d52;
      --text:   #e8eaf0;
      --muted:  #6b7494;
      --green:  #2ecc71;
      --orange: #e67e22;
      --red:    #e74c3c;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%; height: 100%;
      overflow: hidden;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Barlow', sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 1.2rem 1.5rem;
      gap: 1rem;
    }

    /* HEADER */
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.2rem;
      flex-shrink: 0;
      position: relative;
    }
    .logo-badges { display: flex; align-items: center; gap: 0.5rem; }
    .badge-rer {
      background: #1a3a8f; color: white;
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 900; font-size: 1rem;
      padding: 0.2rem 0.5rem; border-radius: 4px;
    }
    .badge-a {
      background: #e2001a; color: white;
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 900; font-size: 1.2rem;
      width: 32px; height: 32px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }
    .badge-sncf {
      background: #c0392b; color: white;
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700; font-size: 0.7rem;
      padding: 0.15rem 0.4rem; border-radius: 3px;
    }
    h1 {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 800; font-size: 2.2vw;
      letter-spacing: 0.04em; text-transform: uppercase; color: white;
    }
    .live-dot {
      position: absolute; top: 4px; right: 0;
      width: 12px; height: 12px;
      background: var(--green); border-radius: 50%;
      animation: livepulse 2.5s ease-in-out infinite;
    }
    @keyframes livepulse {
      0%,100% { opacity:1; transform:scale(1); }
      50%      { opacity:.3; transform:scale(.7); }
    }

    /* GRILLE */
    .grid-top {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      flex: 1;
      min-height: 0;
    }
    .grid-bottom {
      flex-shrink: 0;
    }

    /* PANNEAU */
    .panel {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .panel-title {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700; font-size: 1.2rem;
      letter-spacing: 0.1em; text-transform: uppercase;
      color: white; text-align: center;
      padding: 0.75rem 1rem;
      background: var(--bg3);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .panel-body { padding: 1.2rem; flex: 1; overflow: hidden; }

    /* RETARDS */
    .delay-row {
      display: flex; align-items: baseline; gap: 1rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
    }
    .delay-row:last-child { border-bottom: none; }
    .delay-mission {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 800; font-size: 3.5vw;
      color: white; letter-spacing: 0.03em; min-width: 10vw;
    }
    .delay-mins {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700; font-size: 3.2vw;
    }
    .delay-mins.orange { color: var(--orange); }
    .delay-mins.red    { color: var(--red); }
    .no-delay {
      display: flex; align-items: center; justify-content: center;
      height: 100%; flex-direction: column; gap: 0.75rem;
      color: var(--muted); font-size: 1vw;
    }
    .no-delay-dot {
      width: 10px; height: 10px;
      background: var(--green); border-radius: 50%;
      animation: livepulse 2s infinite;
    }

    /* ÉTAT TRAFIC */
    .trafic-state-box {
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      height: 100%;
      background: transparent;
    }
    .trafic-state-capsule {
      display: flex; align-items: center; justify-content: center;
      width: 70%; padding: 2.5vw 0;
      border-radius: 2vw;
    }
    .trafic-state-box.fluide    .trafic-state-capsule { background: var(--green); }
    .trafic-state-box.perturbe  .trafic-state-capsule { background: var(--orange); }
    .trafic-state-box.interrompu .trafic-state-capsule { background: var(--red); }
    .trafic-state-label {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 900; font-size: 5vw;
      color: white; letter-spacing: 0.05em; text-transform: uppercase;
    }

    /* COMMUNICATION */
    .comm-inner {
      display: flex; gap: 1rem;
    }
    .comm-msg {
      flex: 1;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.9rem 1.2rem;
      font-size: 1vw; line-height: 1.6;
      color: var(--text);
    }
    .comm-msg.perturbe  { border-left: 4px solid var(--orange); color: #f0a870; }
    .comm-msg.interrompu { border-left: 4px solid var(--red);    color: #f08080; }
    .no-comm {
      display: flex; align-items: center; justify-content: center;
      padding: 1rem; color: var(--muted); font-size: 0.9rem;
    }

    .timestamp {
      text-align: center; font-size: 0.7rem;
      color: var(--muted); flex-shrink: 0; letter-spacing: 0.05em;
    }
    .error-box {
      background: rgba(231,76,60,.1); border: 1px solid rgba(231,76,60,.3);
      border-radius: 8px; padding: 1rem; font-size: .8rem; color: #e74c3c;
    }
  </style>
</head>
<body>

<header>
  <div class="logo-badges">
    <div class="badge-rer">RER</div>
    <div class="badge-a">A</div>
    <div class="badge-sncf">SNCF</div>
  </div>
  <h1>Supervision des RER A Ouest</h1>
  <div class="live-dot"></div>
</header>

<div class="grid-top">

  <!-- PANNEAU 1 : RETARDS -->
  <div class="panel">
    <div class="panel-title">Retards en cours</div>
    <div class="panel-body" id="panel-retards">
      <div class="no-delay"><div class="no-delay-dot"></div>Chargement…</div>
    </div>
  </div>

  <!-- PANNEAU 2 : ÉTAT DU TRAFIC -->
  <div class="panel">
    <div class="panel-title">État du trafic</div>
    <div class="panel-body" style="padding:0.5rem;">
      <div class="trafic-state-box fluide" id="trafic-box">
        <div class="trafic-state-capsule">
          <div class="trafic-state-label" id="trafic-label">Fluide</div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- BARRE BAS : COMMUNICATION -->
<div class="grid-bottom">
  <div class="panel">
    <div class="panel-title">Communication</div>
    <div class="panel-body" id="panel-comm">
      <div class="no-comm">Chargement…</div>
    </div>
  </div>
</div>

<div class="timestamp" id="ts">—</div>

<script>
  var PROXY = 'https://rera-proxy.sammy-avcuoglu.workers.dev/proxy';
  var STOP  = 'STIF:StopArea:SP:43191:';
  var LINE  = 'STIF:Line::C01742:';
  var timer = null;

  function esc(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function fetchData() {
    fetch(PROXY + '/stop-monitoring?MonitoringRef=' + encodeURIComponent(STOP), {
      headers: { 'Accept': 'application/json' }
    })
    .then(function(r) { return r.json(); })
    .then(function(d) { renderRetards(d); })
    .catch(function(e) {
      document.getElementById('panel-retards').innerHTML =
        '<div class="error-box">Erreur : ' + esc(e.message) + '</div>';
    });

    fetch(PROXY + '/general-message?LineRef=' + encodeURIComponent(LINE), {
      headers: { 'Accept': 'application/json' }
    })
    .then(function(r) { return r.json(); })
    .then(function(d) { renderTrafic(d); })
    .catch(function() {});

    document.getElementById('ts').textContent =
      'Actualisé à ' + new Date().toLocaleTimeString('fr-FR',
        { hour:'2-digit', minute:'2-digit', second:'2-digit' });

    startCountdown();
  }

  function renderRetards(data) {
    var visits = [];
    try {
      visits = data.Siri.ServiceDelivery.StopMonitoringDelivery[0].MonitoredStopVisit || [];
    } catch(e) {}

    var retards = [];
    for (var i = 0; i < visits.length; i++) {
      var v     = visits[i];
      var call  = (v.MonitoredVehicleJourney && v.MonitoredVehicleJourney.MonitoredCall) || {};
      var j2    = v.MonitoredVehicleJourney || {};
      var dept  = call.ExpectedDepartureTime || call.AimedDepartureTime;
      var aimed = call.AimedDepartureTime;
      if (!dept || !aimed) continue;
      var delayMins = Math.round((new Date(dept) - new Date(aimed)) / 60000);
      if (delayMins < 1) continue;
      var mission = '';
      try { mission = j2.VehicleJourneyName[0].value; } catch(e) {}
      if (!mission) try { mission = j2.JourneyNote[0].value; } catch(e) {}
      retards.push({ mission: mission, delay: delayMins });
    }

    var el = document.getElementById('panel-retards');
    if (!retards.length) {
      el.innerHTML = '<div class="no-delay"><div class="no-delay-dot"></div>Aucun retard détecté</div>';
      return;
    }
    var html = '';
    for (var k = 0; k < retards.length; k++) {
      var cls = retards[k].delay >= 10 ? 'red' : 'orange';
      html += '<div class="delay-row">';
      html += '<div class="delay-mission">' + esc(retards[k].mission) + '</div>';
      html += '<div class="delay-mins ' + cls + '">+' + retards[k].delay + ' min</div>';
      html += '</div>';
    }
    el.innerHTML = html;
  }

  function renderTrafic(data) {
    var msgs = [];
    try {
      msgs = data.Siri.ServiceDelivery.GeneralMessageDelivery[0].InfoMessage || [];
    } catch(e) {}

    var box   = document.getElementById('trafic-box');
    var label = document.getElementById('trafic-label');
    var comm  = document.getElementById('panel-comm');

    var hasInterrompu = false;
    var hasPerturbe   = false;
    var allBodies     = [];

    for (var i = 0; i < msgs.length; i++) {
      var body = '';
      try { body = msgs[i].Content.Message[0].MessageText.value; } catch(e) {}
      if (!body) continue;
      allBodies.push(body);
      var low = body.toLowerCase();
      var isInterrompu = low.indexOf('interrompu') !== -1;
      var isTravaux    = low.indexOf('travaux') !== -1;
      // Interrompu réel = interrompu SANS travaux
      if (isInterrompu && !isTravaux) hasInterrompu = true;
      // interrompu + travaux → ignoré pour l'état du trafic (travaux planifiés)
      else if (!isInterrompu && (low.indexOf('perturbé') !== -1 || low.indexOf('perturbe') !== -1)) hasPerturbe = true;
    }

    // Panneau état
    box.className = 'trafic-state-box';
    if (hasInterrompu) {
      box.classList.add('interrompu');
      label.textContent = 'Interrompu';
    } else if (hasPerturbe) {
      box.classList.add('perturbe');
      label.textContent = 'Perturbé';
    } else {
      box.classList.add('fluide');
      label.textContent = 'Fluide';
    }

    // Panneau communication — tous les messages
    if (!allBodies.length) {
      comm.innerHTML = '<div class="no-comm">Aucun message en cours.</div>';
      return;
    }
    var html = '';
    for (var j = 0; j < allBodies.length; j++) {
      var txt  = allBodies[j];
      var low2 = txt.toLowerCase();
      var c    = '';
      var isInt2 = low2.indexOf('interrompu') !== -1;
      var isTrv2 = low2.indexOf('travaux') !== -1;
      // Interrompu + travaux = bordure orange (travaux planifiés)
      if (isInt2 && !isTrv2) c = 'interrompu';
      else if (isInt2 && isTrv2) c = 'perturbe';
      else if (low2.indexOf('perturbé') !== -1 || low2.indexOf('perturbe') !== -1) c = 'perturbe';
      html += '<div class="comm-msg ' + c + '">' + esc(txt) + '</div>';
    }
    comm.innerHTML = html;
  }

  function startCountdown() {
    clearTimeout(timer);
    timer = setTimeout(fetchData, 45000);
  }

  fetchData();
</script>
</body>
</html>
