<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Graphique Poissy — OPERA</title>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg:     #1e2330;
      --bg2:    #252b3b;
      --bg3:    #2d3447;
      --border: #353d52;
      --text:   #e8eaf0;
      --muted:  #6b7494;
      --green:  #2ecc71;
      --orange: #e67e22;
      --red:    #e74c3c;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Barlow', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 1rem 2rem 1.5rem;
      gap: 0.8rem;
    }

    /* ── HEADER ── */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .header-left {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }
    .projet-nom {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 900;
      font-size: 1rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .graphique-nom {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      font-size: 1.6rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: white;
    }
    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.2rem;
    }
    .horloge {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      font-size: 2rem;
      color: white;
      letter-spacing: 0.05em;
    }
    .refresh-info {
      font-size: 0.62rem;
      color: var(--muted);
      letter-spacing: 0.05em;
    }
    .progress-wrap {
      width: 100%;
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: var(--green);
      border-radius: 2px;
      width: 100%;
      transform-origin: left;
      transition: background 0.3s;
    }
    .progress-bar.epuise { background: var(--orange); }

    /* ── PLAN ── */
    .plan {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 2rem 3rem 1.8rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .sens-label {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 0.78rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 0.3rem;
    }

    .rail {
      display: flex;
      align-items: center;
      position: relative;
      height: 130px;
    }
    .rail::before {
      content: '';
      position: absolute;
      left: 60px; right: 60px;
      top: 50%;
      height: 4px;
      background: var(--border);
      z-index: 0;
    }

    .gare {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
      gap: 6px;
    }

    .train-badge {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 800;
      font-size: 0.8rem;
      letter-spacing: 0.03em;
      background: #1a3a8f;
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      white-space: nowrap;
      min-height: 20px;
      text-align: center;
      transition: opacity 0.3s, background 0.3s;
      opacity: 0;
    }
    .train-badge.visible   { opacity: 1; }
    .train-badge.a-lheure  { background: #1a6b3a; }
    .train-badge.en-retard { background: var(--red); }

    .gare-point {
      width: 38px;
      height: 38px;
      border-radius: 8px;
      border: 2px solid var(--muted);
      background: var(--bg);
      transition: background 0.5s, border-color 0.5s;
    }
    .gare-point.vert   { background: var(--green);  border-color: var(--green); }
    .gare-point.orange { background: var(--orange); border-color: var(--orange); }
    .gare-point.rouge  { background: var(--red);    border-color: var(--red); }
    .gare-point.gris   { background: #2a2f3f; border-color: #3a4052; border-style: dashed; }
    .gare-point.load   { background: #2a3050; border-color: #3a4060; }

    .gare-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    .gare-heure {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      text-align: center;
      transition: color 0.4s;
    }
    .gare-attente {
      font-family: 'Barlow Condensed', sans-serif;
      font-weight: 600;
      font-size: 0.82rem;
      text-align: center;
      transition: color 0.4s;
    }
    .vert   { color: var(--green); }
    .orange { color: var(--orange); }
    .rouge  { color: var(--red); }
    .muted  { color: var(--muted); }

    .rail-sep { height: 6px; }

    .noms { display: flex; margin-top: 0.6rem; }
    .nom {
      flex: 1;
      text-align: center;
      font-size: 0.78rem;
      color: var(--muted);
      line-height: 1.5;
    }
    .nom.principale { color: var(--text); font-weight: 700; font-size: 0.85rem; }
    .nom.terminus   { color: #444; font-style: italic; }

    /* ── LÉGENDE ── */
    .legende {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      justify-content: center;
      font-size: 0.7rem;
      color: var(--muted);
      flex-shrink: 0;
    }
    .leg-item { display: flex; align-items: center; gap: 0.4rem; }
    .leg-dot { width: 13px; height: 13px; border-radius: 3px; border: 2px solid currentColor; }
    .leg-dot.vert    { color: var(--green);  background: var(--green); }
    .leg-dot.orange  { color: var(--orange); background: var(--orange); }
    .leg-dot.rouge   { color: var(--red);    background: var(--red); }
    .leg-dot.gris    { color: #444; background: #2a2f3f; border-style: dashed; }
  </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-left">
    <div class="projet-nom">OPERA — Supervision RER A Ouest</div>
    <div class="graphique-nom">Graphique Poissy</div>
  </div>
  <div class="header-right">
    <div class="horloge" id="horloge">--:--</div>
    <div class="refresh-info" id="refresh-info">Chargement…</div>
    <div class="progress-wrap">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
  </div>
</div>

<!-- PLAN DE LIGNE -->
<div class="plan">

  <div class="sens-label">→ Trait 1 — Sens Paris (Saint-Lazare)</div>
  <div class="rail">
    <div class="gare">
      <div class="train-badge" id="bdg-1-poissy"></div>
      <div class="gare-point load" id="pt-1-poissy"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-1-poissy">--:--</div>
        <div class="gare-attente muted" id="att-1-poissy">…</div>
      </div>
    </div>
    <div class="gare">
      <div class="train-badge" id="bdg-1-agc"></div>
      <div class="gare-point load" id="pt-1-agc"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-1-agc">--:--</div>
        <div class="gare-attente muted" id="att-1-agc">…</div>
      </div>
    </div>
    <div class="gare">
      <div class="train-badge" id="bdg-1-ml"></div>
      <div class="gare-point load" id="pt-1-ml"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-1-ml">--:--</div>
        <div class="gare-attente muted" id="att-1-ml">…</div>
      </div>
    </div>
    <div class="gare">
      <div class="train-badge" id="bdg-1-sartr"></div>
      <div class="gare-point load" id="pt-1-sartr"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-1-sartr">--:--</div>
        <div class="gare-attente muted" id="att-1-sartr">…</div>
      </div>
    </div>
    <div class="gare">
      <div class="train-badge" id="bdg-1-houilles"></div>
      <div class="gare-point load" id="pt-1-houilles"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-1-houilles">--:--</div>
        <div class="gare-attente muted" id="att-1-houilles">…</div>
      </div>
    </div>
  </div>

  <div class="rail-sep"></div>

  <div class="rail">
    <div class="gare">
      <div class="train-badge" style="opacity:0"></div>
      <div class="gare-point gris"></div>
      <div class="gare-info">
        <div class="gare-heure muted">—</div>
        <div class="gare-attente muted">Terminus</div>
      </div>
    </div>
    <div class="gare">
      <div class="train-badge" id="bdg-2-agc"></div>
      <div class="gare-point load" id="pt-2-agc"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-2-agc">--:--</div>
        <div class="gare-attente muted" id="att-2-agc">…</div>
      </div>
    </div>
    <div class="gare">
      <div class="train-badge" id="bdg-2-ml"></div>
      <div class="gare-point load" id="pt-2-ml"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-2-ml">--:--</div>
        <div class="gare-attente muted" id="att-2-ml">…</div>
      </div>
    </div>
    <div class="gare">
      <div class="train-badge" id="bdg-2-sartr"></div>
      <div class="gare-point load" id="pt-2-sartr"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-2-sartr">--:--</div>
        <div class="gare-attente muted" id="att-2-sartr">…</div>
      </div>
    </div>
    <div class="gare">
      <div class="train-badge" id="bdg-2-houilles"></div>
      <div class="gare-point load" id="pt-2-houilles"></div>
      <div class="gare-info">
        <div class="gare-heure muted" id="heure-2-houilles">--:--</div>
        <div class="gare-attente muted" id="att-2-houilles">…</div>
      </div>
    </div>
  </div>
  <div class="sens-label" style="text-align:right; margin-top:0.3rem;">← Trait 2 — Sens Poissy</div>

  <div class="noms">
    <div class="nom terminus">Poissy</div>
    <div class="nom">Achères<br>Gc</div>
    <div class="nom principale">Maisons<br>Laffitte</div>
    <div class="nom">Sartrouville</div>
    <div class="nom principale">Houilles<br>Carr. s/S</div>
  </div>

</div>

<!-- LÉGENDE -->
<div class="legende">
  <div class="leg-item"><div class="leg-dot vert"></div> Prochain train disponible</div>
  <div class="leg-item"><div class="leg-dot orange"></div> Attente modérée</div>
  <div class="leg-item"><div class="leg-dot rouge"></div> Attente longue</div>
  <div class="leg-item"><div class="leg-dot gris"></div> Terminus</div>
</div>

<script>
  var PROXY = 'https://rera-proxy.sammy-avcuoglu.workers.dev/proxy';
  var LINE  = 'STIF:Line::C01742:';
  var INTERVALLE = 45000; // 45 secondes

  var STOPS = {
    poissy:   'STIF:StopArea:SP:47874:',
    agc:      'STIF:StopArea:SP:47915:',
    ml:       'STIF:StopArea:SP:65048:',
    sartr:    'STIF:StopArea:SP:43191:',
    houilles: 'STIF:StopArea:SP:43082:'
  };

  var FILTRE_PARIS = {
    poissy:   ['boissy', 'marne', 'torcy', 'chessy', 'defense', 'défense'],
    agc:      ['boissy', 'marne', 'torcy', 'chessy', 'defense', 'défense'],
    ml:       ['boissy', 'marne', 'torcy', 'chessy', 'defense', 'défense'],
    sartr:    ['boissy', 'marne', 'torcy', 'chessy', 'defense', 'défense'],
    houilles: ['boissy', 'marne', 'torcy', 'chessy', 'defense', 'défense']
  };
  var FILTRE_POISSY = ['poissy'];

  // ── HORLOGE ──
  function majHorloge() {
    var now = new Date();
    var h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
    document.getElementById('horloge').textContent =
      (h<10?'0'+h:h)+':'+(m<10?'0'+m:m)+':'+(s<10?'0'+s:s);
  }
  setInterval(majHorloge, 1000);
  majHorloge();

  // ── BARRE DE PROGRESSION ──
  var progressStart = null;
  var progressRAF   = null;

  function demarrerBarre() {
    progressStart = Date.now();
    var bar = document.getElementById('progress-bar');
    bar.classList.remove('epuise');

    function animer() {
      var elapsed = Date.now() - progressStart;
      var pct = Math.min(elapsed / INTERVALLE, 1);
      bar.style.transform = 'scaleX(' + (1 - pct) + ')';
      if (pct >= 0.85) bar.classList.add('epuise');
      if (pct < 1) {
        progressRAF = requestAnimationFrame(animer);
      }
    }
    if (progressRAF) cancelAnimationFrame(progressRAF);
    progressRAF = requestAnimationFrame(animer);
  }

  // ── UTILITAIRES ──
  function formatHeure(isoStr) {
    if (!isoStr) return '--:--';
    var d = new Date(isoStr);
    var h = d.getHours(), m = d.getMinutes();
    return (h<10?'0'+h:h)+'h'+(m<10?'0'+m:m);
  }

  function minutesDepuis(isoStr) {
    if (!isoStr) return null;
    return Math.round((new Date(isoStr) - new Date()) / 60000);
  }

  function couleur(attMin) {
    if (attMin === null || attMin < 0) return 'muted';
    if (attMin < 5)  return 'vert';
    if (attMin < 15) return 'orange';
    return 'rouge';
  }

  function destinationMatch(destName, filtres) {
    if (!destName) return false;
    var d = destName.toLowerCase();
    for (var i = 0; i < filtres.length; i++) {
      if (d.indexOf(filtres[i]) !== -1) return true;
    }
    return false;
  }

  function majGareDOM(trait, gare, data) {
    var pt    = document.getElementById('pt-'    + trait + '-' + gare);
    var badge = document.getElementById('bdg-'   + trait + '-' + gare);
    var heure = document.getElementById('heure-' + trait + '-' + gare);
    var att   = document.getElementById('att-'   + trait + '-' + gare);
    if (!pt || !badge || !heure || !att) return;

    if (!data) {
      pt.className = 'gare-point load';
      badge.className = 'train-badge';
      badge.textContent = '';
      heure.textContent = '--:--';
      heure.className = 'gare-heure muted';
      att.textContent = '—';
      att.className = 'gare-attente muted';
      return;
    }

    var etat = couleur(data.attente);
    pt.className = 'gare-point ' + etat;

    var badgeTxt = data.mission || '?';
    if (data.retard > 0) badgeTxt += ' +' + data.retard + 'min';
    badge.textContent = badgeTxt;
    badge.className = 'train-badge visible ' + (data.retard > 0 ? 'en-retard' : 'a-lheure');

    heure.textContent = data.heureEstimee;
    heure.className = 'gare-heure ' + etat;

    att.textContent = data.attente <= 0 ? 'À quai' : data.attente + ' min';
    att.className = 'gare-attente ' + etat;
  }

  // ── FETCH UNE GARE ──
  function fetchGare(stopId, filtresDest) {
    return fetch(PROXY + '/stop-monitoring?MonitoringRef=' + encodeURIComponent(stopId), { cache: 'no-store' })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var visits = [];
        try { visits = data.Siri.ServiceDelivery.StopMonitoringDelivery[0].MonitoredStopVisit || []; } catch(e) {}

        var candidats = [];
        for (var i = 0; i < visits.length; i++) {
          var v = visits[i];
          var j = v.MonitoredVehicleJourney || {};
          var call = j.MonitoredCall || {};

          var lineRef = '';
          try { lineRef = j.LineRef.value; } catch(e) {}
          if (lineRef !== LINE) continue;

          var destName = '';
          try { destName = j.DestinationName[0].value; } catch(e) {}
          if (!destinationMatch(destName, filtresDest)) continue;

          var dept  = call.ExpectedDepartureTime || call.AimedDepartureTime;
          var aimed = call.AimedDepartureTime;
          if (!dept) continue;

          var attMin = minutesDepuis(dept);
          if (attMin !== null && attMin < -1) continue;

          var retard = 0;
          if (dept && aimed) retard = Math.max(0, Math.round((new Date(dept) - new Date(aimed)) / 60000));

          var mission = '';
          try { mission = j.VehicleJourneyName[0].value; } catch(e) {}
          if (!mission) try { mission = j.JourneyNote[0].value; } catch(e) {}

          candidats.push({ mission: mission, heureEstimee: formatHeure(dept), attente: attMin, retard: retard });
        }

        candidats.sort(function(a, b) { return a.attente - b.attente; });
        return candidats.length > 0 ? candidats[0] : null;
      });
  }

  // ── FETCH TOUTES LES GARES ──
  function fetchAll() {
    document.getElementById('refresh-info').textContent = 'Actualisation…';

    var taches = [
      { trait:'1', gare:'poissy',   stop: STOPS.poissy,   filtres: FILTRE_PARIS.poissy },
      { trait:'1', gare:'agc',      stop: STOPS.agc,      filtres: FILTRE_PARIS.agc },
      { trait:'1', gare:'ml',       stop: STOPS.ml,       filtres: FILTRE_PARIS.ml },
      { trait:'1', gare:'sartr',    stop: STOPS.sartr,    filtres: FILTRE_PARIS.sartr },
      { trait:'1', gare:'houilles', stop: STOPS.houilles, filtres: FILTRE_PARIS.houilles },
      { trait:'2', gare:'agc',      stop: STOPS.agc,      filtres: FILTRE_POISSY },
      { trait:'2', gare:'ml',       stop: STOPS.ml,       filtres: FILTRE_POISSY },
      { trait:'2', gare:'sartr',    stop: STOPS.sartr,    filtres: FILTRE_POISSY },
      { trait:'2', gare:'houilles', stop: STOPS.houilles, filtres: FILTRE_POISSY }
    ];

    Promise.all(taches.map(function(t) {
      return fetchGare(t.stop, t.filtres)
        .then(function(data) { majGareDOM(t.trait, t.gare, data); })
        .catch(function()    { majGareDOM(t.trait, t.gare, null); });
    })).then(function() {
      var now = new Date();
      var h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
      document.getElementById('refresh-info').textContent =
        'Actualisé à ' + (h<10?'0'+h:h)+':'+(m<10?'0'+m:m)+':'+(s<10?'0'+s:s);
      demarrerBarre();
    });

    setTimeout(fetchAll, INTERVALLE);
  }

  fetchAll();
</script>
</body>
</html>
